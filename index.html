<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas&#43;Neue&amp;display=swap" rel="stylesheet">
        <link href="style.css" rel="stylesheet">        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>

        <script>
            var _products = [{"name":"Midnight Run","ingredients":[{"name":"Coffee Beans","qty":2}],"cost":0,"rrp":50,"type":"Coffee"},{"name":"Pale Imitation","ingredients":[{"name":"Coffee Beans","qty":1},{"name":"Liquid Whitener","qty":1},{"name":"Milk","qty":1}],"cost":0,"rrp":65,"type":"Coffee"},{"name":"Whiter Shade of Pale","ingredients":[{"name":"Coffee Beans","qty":1},{"name":"Liquid Whitener","qty":1},{"name":"Milk","qty":1}],"cost":0,"rrp":65,"type":"Coffee"},{"name":"Mochary of Justice","ingredients":[{"name":"Coffee Beans","qty":1},{"name":"Milk","qty":1},{"name":"Cocoa Bean","qty":1}],"cost":0,"rrp":75,"type":"Coffee"},{"name":"Ex-presso","ingredients":[{"name":"Coffee Beans","qty":1},{"name":"Bottle of Water","qty":2}],"cost":0,"rrp":50,"type":"Coffee"},{"name":"Shot in the Dark","ingredients":[{"name":"Kopi Luwak Beans","qty":1},{"name":"Gunpowder","qty":1}],"cost":0,"rrp":95,"type":"Premium Coffee"},{"name":"Deja Brew","ingredients":[{"name":"Milk","qty":1},{"name":"Kopi Luwak Beans","qty":1},{"name":"Cocoa Bean","qty":1}],"cost":0,"rrp":95,"type":"Premium Coffee"},{"name":"Frighter Shade of Pale","ingredients":[{"name":"Pumpkin","qty":1},{"name":"Milk","qty":1},{"name":"Coffee Beans","qty":1}],"cost":0,"rrp":75,"type":"Seasonal Coffee"},{"name":"Sinner Man's Vice","ingredients":[{"name":"Coffee Beans","qty":1},{"name":"Milk","qty":1},{"name":"Cinnamon","qty":1}],"cost":0,"rrp":75,"type":"Seasonal Coffee"},{"name":"Cold Catalyst","ingredients":[{"name":"Sugar","qty":1},{"name":"Bottle of Water","qty":1},{"name":"Coffee Beans","qty":1}],"cost":0,"rrp":50,"type":"Granita"},{"name":"You Do Yuzu","ingredients":[{"name":"Yuzu","qty":1},{"name":"Bottle of Water","qty":1},{"name":"Sugar","qty":1}],"cost":0,"rrp":50,"type":"Granita"},{"name":"Speedball","ingredients":[],"cost":20,"rrp":25,"type":"Snack"},{"name":"Centillionaire Shortbread","ingredients":[],"cost":20,"rrp":25,"type":"Snack"},{"name":"Shock & Awe Financier","ingredients":[],"cost":20,"rrp":25,"type":"Snack"},{"name":"Bullet Times","ingredients":[],"cost":20,"rrp":25,"type":"Snack"},{"name":"Frosted Cronuts","ingredients":[],"cost":20,"rrp":25,"type":"Snack"},{"name":"Top Hole","ingredients":[],"cost":20,"rrp":25,"type":"Snack"},{"name":"eCola","ingredients":[],"cost":10,"rrp":50,"type":"Forbidden"},{"name":"eCola Light","ingredients":[],"cost":10,"rrp":50,"type":"Forbidden"},{"name":"Sprunk","ingredients":[],"cost":10,"rrp":50,"type":"Forbidden"},{"name":"Sprunk Light","ingredients":[],"cost":10,"rrp":50,"type":"Forbidden"},{"name":"Whiskey","ingredients":[],"cost":50,"rrp":95,"type":"Forbidden"},{"name":"Vodka","ingredients":[],"cost":42,"rrp":75,"type":"Forbidden"},{"name":"Beer","ingredients":[],"cost":35,"rrp":65,"type":"Forbidden"}];
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            

            
                
                
                
            
            var _ingredients = [{"name":"Coffee Beans","cost":20},{"name":"Kopi Luwak Beans","cost":20},{"name":"Sugar","cost":10},{"name":"Milk","cost":20},{"name":"Liquid Whitener","cost":10},{"name":"Bottle of Water","cost":10},{"name":"Gunpowder","cost":10},{"name":"Cocoa Bean","cost":20},{"name":"Yuzu","cost":20},{"name":"Pumpkin","cost":20},{"name":"Cinnamon","cost":20}];
            var _taxRate = 0.0999;
            var _discount = 0.1;

            var _order = {
                "products": [],
                "ingredients": [],
                "cost":0,
                "rrp":0,
                "charge":0,
                "tax":0,
                "net":0,
                "profit":0
            }

            var closeOnOrderConfirmation = true;
            var discountApplied = false;

            function calculateIngredientsCosts(ingredients)
            {
                var cost = 0;
                ingredients.forEach( ingredient => {
                    var found = _ingredients.find( (ing) => { return (ing.name == ingredient.name); } )
                    cost += found.cost * ingredient.qty;
                } );
                return cost;
            }

            function calculateOrder()
            {
                var cumulativeCost = 0;
                var cumulativeRrp = 0;
                for( var i=0; i < _order.products.length; ++i )
                {
                    cumulativeCost += calculateIngredientsCosts(_order.products[i].product.ingredients) * _order.products[i].qty;
                    cumulativeCost += _order.products[i].product.cost * _order.products[i].qty;
                    cumulativeRrp += _order.products[i].product.rrp * _order.products[i].qty;
                }

                _order.cost = cumulativeCost;
                _order.rrp = cumulativeRrp; 
                _order.charge = _order.rrp;
                if( discountApplied )
                {
                  _order.charge -= Math.ceil(_order.rrp * _discount);
                }
            }

            function removeFromOrder(productIndex)
            {
                _order.products.splice(productIndex,1);
                updateOrder();
            }

            function getOrderItemQtyId(productName)
            {
                return productName + " order_qty";
            }

            function changeOrderItemQuantity( productName, newQty )
            {
                if( newQty == 0 )
                {
                    var index = _order.products.findIndex( item => item.product.name == productName )
                    if( index > -1 )
                    {
                        _order.products.splice(index, 1);
                        updateOrder();
                    }
                }
                else
                {
                    var foundItem = _order.products.find( item => (item.product.name == productName) );
                    if( foundItem ) {
                        foundItem.qty = Number(newQty);
                        updateOrder();
                    }
                }
            }

            function regenerateOrderList(order)
            {
                var orderList = document.getElementById("orderList");
                while (orderList.lastElementChild) {
                    orderList.removeChild(orderList.lastElementChild);
                }

                for( var i = 0; i < order.products.length; ++i )
                {
                    var rowDiv = document.createElement("li");
                    rowDiv.className = "order-list-row";
                    orderList.appendChild(rowDiv);

                    var nameDiv = document.createElement("div");
                    nameDiv.textContent = order.products[i].product.name;
                    rowDiv.appendChild(nameDiv);

                    var qtyInput = document.createElement("input");
                    qtyInput.setAttribute("type", "number");
                    qtyInput.id = getOrderItemQtyId(order.products[i].product.name);
                    qtyInput.className = "item-order-qty";
                    qtyInput.name = order.products[i].product.name;
                    qtyInput.value = Number(order.products[i].qty);
                    qtyInput.onchange = function(e) { changeOrderItemQuantity(e.target.name, Number(e.target.value)); }
                    rowDiv.appendChild(qtyInput);
                    

                    var buttonParent = document.createElement("div");
                    buttonParent.className = "btn-parent";
                    var button = document.createElement("button");
                    button.classList.add("btn-remove");
                    button.value = i;
                    button.onclick = function() { removeFromOrder(this.value); };
                    rowDiv.appendChild(buttonParent);
                    buttonParent.appendChild(button);
                }
            }

            function regenerateIngredientsList(order)
            {
                var ingredientsList = document.getElementById("ingredientsList");
                while (ingredientsList.lastElementChild) {
                    ingredientsList.removeChild(ingredientsList.lastElementChild);
                }

                for( var i = 0; i < order.ingredients.length; ++i )
                {
                    var rowDiv = document.createElement("div");
                    rowDiv.className = "row";
                    ingredientsList.appendChild(rowDiv);

                    var nameDiv = document.createElement("div");
                    nameDiv.className = "col";
                    nameDiv.textContent = order.ingredients[i].name;
                    rowDiv.appendChild(nameDiv);

                    var qtyDiv = document.createElement("div");
                    qtyDiv.className = "col-sm";
                    qtyDiv.innerText = order.ingredients[i].qty;
                    rowDiv.appendChild(qtyDiv);
                }
            }

            function addItem()
            {
                var productSelection = document.getElementById("productSelection").value;
                if( productSelection == "Select Product" ) { return; }
                var productIndex = Number(productSelection);
                var productQuantity = Number(document.getElementById("productQuantity").value);
                if( productQuantity <= 0 ) { return; }
                var itemToAdd = { "product": _products[productIndex], "qty":productQuantity }

                
                
                
                
                
                  _order.products.push( itemToAdd );
                
                
                
                
                

                updateOrder();
            }

            function updateIngredientsList()
            {
                _order.ingredients = [];

                for(var productIndex=0; productIndex < _order.products.length; ++productIndex)
                {
                    var product = _order.products[productIndex].product;
                    var qty = _order.products[productIndex].qty;

                    for(var ingIndex = 0; ingIndex < product.ingredients.length; ++ingIndex)
                    {
                        var ingredient = product.ingredients[ingIndex];
                        var foundIndex = _order.ingredients.findIndex( (ing) => { return ing.name == ingredient.name; } );
                        if( foundIndex >= 0 )
                        {
                            _order.ingredients[foundIndex].qty += ingredient.qty * qty;
                        }
                        else
                        {
                            _order.ingredients.push( { "name": ingredient.name, "qty": ingredient.qty * qty  } );
                        }
                    }
                }
            }

            function updateOrderDetails(order)
            {
                document.getElementById("orderCost").innerHTML = order.cost;
                document.getElementById("orderRrp").innerHTML = order.rrp;
                document.getElementById("orderCharge").value = order.charge;
            }

            function updateOrder()
            {
                updateIngredientsList();
                calculateOrder();
                regenerateOrderList(_order);
                regenerateIngredientsList(_order);
                updateOrderDetails(_order);
            }

            function addProductSelection(products)
            {
                var selection = document.getElementById("productSelection");

                for( var i=0; i < products.length; ++i )
                {
                    var option = document.createElement("option");
                    option.textContent = products[i].name;
                    option.value = i;
                    selection.appendChild(option);
                }
            }

            function confirmOrder()
            {
              if( _order.products.length > 0 )
              {
                _order.charge = document.getElementById("orderCharge").value;
                _order.tax = Math.floor(_taxRate * _order.charge);
                _order.net = _order.charge - _order.tax;
                _order.profit = _order.net - _order.cost;
                              }
              else
              {
                alert("No items in order, please add items or cancel")
              }
            }
            function addItemByName(productName)
            {
                var foundProduct = _products.find( item => item.name == productName )
                if( foundProduct == null ) {
                    return;
                }

                var productQuantity = 1;
                var itemToAdd = { "product": foundProduct, "qty":productQuantity }

                
                var foundIndex = _order.products.findIndex( item => (item.product.name == foundProduct.name) );
                if( foundIndex < 0 ) {
                    
                    _order.products.push( itemToAdd );
                }
                else {
                    _order.products[foundIndex].qty += productQuantity;
                }
                updateOrder();
            }

            function applyStyle(productElement, productType)
            {
                productElement.classList.add("btn-product");

                switch( productType )
                {
                    case "Coffee":
                        productElement.classList.add("btn--coffee");
                        break;
                    case "Premium Coffee":
                        productElement.classList.add("btn--premium-coffee");
                        break;
                    case "Granita":
                        productElement.classList.add("btn--granita");
                        break;
                    case "Snack":
                        productElement.classList.add("btn--snack");
                        break;
                    case "Forbidden":
                        productElement.classList.add("btn--forbidden");
                        break;
                    case "Seasonal Coffee":
                        productElement.classList.add("btn--seasonal-coffee");
                        break;
                }
            }

            function addProductSelectionGrid(products)
            {
                var selection = document.getElementById("productSelectionGrid");

                for( var i=0; i < products.length; ++i )
                {
                    var option = document.createElement("button");
                    applyStyle( option, products[i].type );
                    option.id = products[i].name;
                    option.textContent = products[i].name;
                    option.onclick = function(e) {
                        addItemByName( e.target.id );
                    }
                    selection.appendChild(option);
                }
            }

            function resetOrder()
            {
                _order.products.splice(0, _order.products.length);
                updateOrder();
            }

            function onLoad()
            {
                addProductSelectionGrid(_products);
                
                var confirmButton = document.getElementById("confirmButton");
                if( confirmButton )
                {
                    confirmButton.addEventListener("click", confirmOrder);
                }

                var closeSetting = document.getElementById("closeSetting");
                if( closeSetting )
                {
                    closeSetting.addEventListener("change", function(){ closeOnOrderConfirmation = !this.checked; });
                }

                var discountSetting = document.getElementById('discountSetting');
                if( discountSetting )
                {
                  discountSetting.checked = discountApplied;
                  discountSetting.addEventListener("change", function(){ discountApplied = this.checked; updateOrder(); });
                }
            }
        </script>
  </head>
  <body onload="onLoad()">
    <div id="epos-container">
        <div id="products-and-ingredients">
            <div id="productSelectionGrid"></div>
            <div id="ingredients-panel">
                <div>Ingredients Required:</div>
                <div id="ingredientsList"></div>
            </div>
        </div>
        <div class="order-contents">
            <div>Order Contents:</div>
            <ul id="orderList"></ul>
            <div class="order-totals">
                <label for="orderCost">Total Cost: </label><div id="orderCost"></div><div>&nbsp;</div>
                <label for="orderRrp">Total RRP: </label><div id="orderRrp"></div><div>&nbsp;</div>
                <label for="orderCharge">Charge: </label><input type="number" id="orderCharge" min="0" /><div>&nbsp;</div>
                
                <div class="col">Orders can only be submitted via Spreadsheet form</div>            </div>
        </div>
    </div>
    </body>
</html>
